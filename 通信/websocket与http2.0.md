# WebSocket与HTTP2.0

## WebSocket
### 简介
WebSocket是一种建立在TCP连接之上的全双工通信协议。2011年被IETF定为标准RFC 6455，并由RFC7936补充规范。
WebSocket使得客户端与服务器端之间的数据交换变得简单，允许服务器主动向客户端推送数据。在WebSocket API中，客户端和服务器之间只要完成一次握手就可以建立持久性连接，进行双向数据传输。
### 优点
1. 较少的控制开销。在连接建立后，在客户端和服务器端之间交换数据时，用于协议控制的数据头部相对较小。
2. 更强的实时性。由于协议是全双工的，所以服务器可以随时主动给客户端下发数据。
3. 保持连接状态。与 HTTP 不同的是，WebSocket 需要先建立连接，这使得其成为一种有状态的协议（HTTP 为无状态协议）。之后的通信可以省略部分状态信息。
4. 更好的二进制支持。WebSocket定义了二进制帧（HTTP 2.0也有二进制帧），相对 HTTP 1.1，可以更好地处理二进制内容。
5. 可以支持扩展。WebSocket定义了扩展，用户可以扩展协议，实现自定义子协议。
6. 更好的压缩性。相对于 HTPP 压缩，WebSocket可以在适当的扩展支持下可以沿用之前内容的上下文，在传递类似数据的时候，可以显著提高压缩率。
7. 多路复用。不同的 URI 可以使用同一个WebSocket 连接。

### 特点
1. 基于 TCP长连接。
2. 使用HTTP1.1进行握手。
3. 支持服务器推送，相对于其他实现方案，比如轮询，长轮询等开销更低，实时性更强。

### 服务器端推送
1. polling（轮询）
2. long polling（长轮询）
3. 永久帧
3. WebSocket
4. HTTP 2

> 轮询需要客户端定时不断地发送请求到服务器端去查询有没有数据，有便取回数据，没有就关闭，因此需要服务器有很高的处理速度和资源；
> 长轮询则是客户端发送一个请求到服务器，如果有数据便取回数据或者超时后关闭连接，然后再次发送一个请求，重复以上过程；没有就继续保持这个链接直到服务器响应，因此需要服务器具有很高的并发处理能力。
> keep-alive在一次 TCP 连接中完成多个 HTTP 请求。

> 以上三者每次发送请求都会携带完整的Header，导致信息交换效率低，浪费带宽；请求与响应需要一一对应。
> keep-alive和long-polling是两回事，Connection: Close和Connection: Keep-Alive都可以支持long-polling，差别只在于开销不同
> KeepAlive是相对于TCP来说的，就是多个HTTP请求使用同一条TCP通道，省掉三步握手。而long polling是对于HTTP来说的。浏览器发起一个HTTP请求后，服务器不返回，而是一直挂着，当有消息的时候返回。浏览器这里一直等着这个请求，一返回马上可以处理数据。超时只是一个补充手段，因为不可能让这个HTTP请求一直挂着


> 相对于轮询，WebSocket 的优势不说自明，但是相对于长轮询，其优势又在哪里呢？
> 参见[WebSocket 是什么原理？为什么可以实现持久连接？](https://www.zhihu.com/question/20215561)简短的讲就是：通常客户端（A）发送的 HTTP请求是要经过nginx服务器（接线员B）处理然后再传给相应的处理程序（客服C）的。B 的处理速度非常快，因此A 与 B 之间的连接非常廉价。但是 C 的处理能力就比较慢了。而 WebSocket 只需要维持 A 与 B 之间的连接即可，一旦C 有消息就通知 B 而不用一直被 A 的连接占用。长轮询则需要维持 A 与 C 的连接，一旦并发量变大，C 的资源就容易耗尽。


